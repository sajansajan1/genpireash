# Tech Files Simplified Implementation Plan
## Using Existing Database Schema (v2.0)

This plan implements the complete Tech Files system using **ONLY existing tables** - no schema changes required!

**Key Innovation:** Uses `revision_vision_analysis` as the primary storage for all AI-extracted tech pack data, enabling view-specific editing with image reference.

---

## ðŸ“Š Database Mapping

### Tables We'll Use:

1. **`product_multiview_revisions`** â­ Primary
   - Store ALL images: base views, close-ups, sketches
   - Use `view_type` for base views (front, back, side, top, bottom)
   - Use `view_type='illustration'` for close-ups
   - Use `view_type='detail'` for technical sketches
   - Use `batch_id` to group related generations
   - Track edit history via `parent_revision_id`

2. **`revision_vision_analysis`** â­ Primary (Tech Pack Data)
   - **THE KEY TABLE** - Stores all AI-extracted tech pack data
   - Links to each revision via `revision_id`
   - `analysis_data` (jsonb) stores all tech pack details
   - `view_type` distinguishes: front, back, side, detail, other
   - `batch_id` groups related analyses
   - Built-in caching via `image_hash`
   - Performance tracking: `tokens_used`, `processing_time_ms`
   - Quality tracking: `confidence_score`

3. **`product_ideas`**
   - Main product container
   - `technical_files_v2` (jsonb) - Store summary/metadata only
   - `technical_images` (jsonb) - Store legacy format for compatibility

4. **`images_uploads`**
   - User-uploaded files (logos, artwork)
   - Print files (PNG, SVG, PDF)
   - Use `metadata` for categorization

5. **`front_view_approvals`**
   - Track 5-view approval workflow
   - Manage credits (3 per generation)
   - Store iteration history

6. **`user_credits`**
   - Deduct credits: 3 + 3 + 3 = 9 total

---

## ðŸŽ¯ Why `revision_vision_analysis` is Perfect

### Built-in Features:
- âœ… **Purpose-built for AI analysis** - Designed to store AI-generated data
- âœ… **One-to-one relationship** - Each image gets one analysis
- âœ… **Caching** - `image_hash` prevents re-analysis
- âœ… **Performance tracking** - `tokens_used`, `processing_time_ms`, `model_used`
- âœ… **Quality metrics** - `confidence_score` per analysis
- âœ… **Batch processing** - `batch_id` groups related items
- âœ… **Status tracking** - `status` field (pending, completed, failed)
- âœ… **Error handling** - `error_message` for failures
- âœ… **Expiration** - `expires_at` for cache management
- âœ… **Proper relationships** - Links to product, user, revision
- âœ… **Session tracking** - `session_id` for workflows

---

## ðŸŽ¯ Data Structure Design

> **âš ï¸ IMPORTANT:** All examples below show SAMPLE data for a t-shirt. In production, **ALL fields are dynamically generated by AI** based on the actual product image. The AI analyzes each product individually and extracts relevant features, dimensions, materials, etc. specific to that product (shoes, bags, furniture, jewelry, etc.).

### Base Views (3 credits) - With AI Tech Pack Analysis

**Image Storage:** `product_multiview_revisions`

```typescript
{
  id: "revision-uuid",
  product_idea_id: "uuid",
  user_id: "uuid",
  view_type: "front" | "back" | "side" | "top" | "bottom",
  image_url: "https://...",
  thumbnail_url: "https://...",
  batch_id: "base-views-[timestamp]",
  edit_type: "generated",
  is_active: true,
  parent_revision_id: null, // null for initial generation
  edit_prompt: null,
  created_at: "2025-01-10T10:00:00Z"
}
```

**Tech Pack Data:** `revision_vision_analysis` â­ NEW APPROACH

```typescript
{
  id: "analysis-uuid",
  product_idea_id: "uuid",
  user_id: "uuid",
  revision_id: "revision-uuid", // Links to product_multiview_revisions
  view_type: "front",
  image_url: "https://...",
  image_hash: "sha256...",
  batch_id: "base-views-[timestamp]",

  // ALL TECH PACK DATA GOES HERE â­
  analysis_data: {
    category: "base_view",

    // AI-extracted features (user can edit)
    detected_features: {
      silhouette: "fitted",
      neckline: "crew neck",
      sleeves: "short sleeve",
      closure: "pullover",
      hem: "straight",
      pocket_style: "none",
      fit: "regular"
    },

    // AI-estimated dimensions (user can edit)
    dimensions: {
      shoulder_width: { value: "45cm", tolerance: "Â±1cm" },
      chest_width: { value: "50cm", tolerance: "Â±1cm" },
      length: { value: "65cm", tolerance: "Â±1cm" },
      sleeve_length: { value: "20cm", tolerance: "Â±0.5cm" }
    },

    // AI-detected materials (user can add/remove)
    materials_detected: [
      {
        name: "Cotton Jersey",
        percentage: "95%",
        component: "main body",
        spec: "180gsm combed cotton"
      },
      {
        name: "Elastane",
        percentage: "5%",
        component: "main body",
        spec: "stretch blend"
      },
      {
        name: "Ribbed Cotton",
        percentage: "100%",
        component: "collar",
        spec: "2x1 rib knit"
      }
    ],

    // AI color analysis
    color_analysis: {
      primary_color: { hex: "#1C1917", name: "Charcoal" },
      accent_colors: [],
      print_colors: [],
      color_matching: "Pantone 19-0303 TPX"
    },

    // AI style analysis
    style_notes: "Modern minimalist design with clean lines and structured silhouette",

    // Manufacturing complexity
    manufacturing: {
      complexity: "medium",
      estimated_sew_time: "12-15 minutes",
      skill_level: "intermediate",
      special_equipment: []
    },

    // Cost estimation
    cost_estimation: {
      material_cost: "$3.50 - $4.50",
      labor_cost: "$2.00 - $3.00",
      total_cog: "$5.50 - $7.50",
      suggested_retail: "$25 - $35"
    },

    // Edit tracking
    user_modifications: false,
    last_edited_at: null,
    edit_history: []
  },

  // AI metadata
  model_used: "gpt-4o",
  tokens_used: 1250,
  processing_time_ms: 3200,
  confidence_score: 0.92,
  status: "completed",
  created_at: "2025-01-10T10:00:05Z",

  // Additional metadata
  metadata: {
    svgUrl: "https://...",
    pngUrl: "https://...",
    approved: false
  }
}
```

**Approval Tracking:** `front_view_approvals`

```typescript
{
  product_idea_id: "uuid",
  user_id: "uuid",
  status: "pending" | "approved" | "rejected",
  front_view_url: "...",
  back_view_url: "...",
  side_view_url: "...",
  top_view_url: "...",
  bottom_view_url: "...",
  credits_consumed: 3,
  iteration_number: 1,
  session_id: "session-uuid"
}
```

### Close-Ups (3 credits) - AI-Generated Detail Shots

**Image Storage:** `product_multiview_revisions`

```typescript
{
  id: "closeup-revision-uuid",
  product_idea_id: "uuid",
  user_id: "uuid",
  view_type: "detail", // Use 'detail' for close-ups
  image_url: "https://closeup.png",
  thumbnail_url: "https://...",
  batch_id: "closeups-[timestamp]",
  edit_type: "generated",
  is_active: true,
  parent_revision_id: null
}
```

**Tech Pack Data:** `revision_vision_analysis` â­

```typescript
{
  id: "analysis-uuid",
  product_idea_id: "uuid",
  user_id: "uuid",
  revision_id: "closeup-revision-uuid",
  view_type: "detail",
  image_url: "https://closeup.png",
  image_hash: "sha256...",
  batch_id: "closeups-[timestamp]",

  analysis_data: {
    category: "close_up",

    // AI-generated (user can edit)
    title: "French Seam Construction",
    description: "Double-stitched French seam provides clean finish on interior while reinforcing stress points for durability.",

    // Detail classification
    detail_type: "construction", // or "hardware", "fabric", "embellishment"

    // Technical specifications
    technical_specs: {
      stitch_type: "French seam",
      stitch_length: "2.5mm",
      seam_allowance: "1.5cm",
      thread_type: "polyester 40/2"
    },

    // Quality indicators
    quality_indicators: {
      stitch_consistency: "excellent",
      alignment: "precise",
      finish_quality: "professional"
    },

    // User notes
    notes: "", // User can add custom notes
    order: 1,

    // Edit tracking
    user_modifications: false,
    edit_history: []
  },

  model_used: "gpt-4o",
  confidence_score: 0.94,
  status: "completed",

  metadata: {
    svgUrl: "https://...",
    source_view: "front"
  }
}
```

### Technical Sketches + Call-Outs (3 credits)

**Image Storage:** `product_multiview_revisions`

```typescript
{
  id: "sketch-revision-uuid",
  product_idea_id: "uuid",
  user_id: "uuid",
  view_type: "front", // or "back", "side"
  image_url: "https://sketch.png",
  thumbnail_url: "https://...",
  batch_id: "sketches-[timestamp]",
  edit_type: "generated",
  is_active: true,
  parent_revision_id: null
}
```

**Tech Pack Data with Call-Outs:** `revision_vision_analysis` â­

```typescript
{
  id: "analysis-uuid",
  product_idea_id: "uuid",
  user_id: "uuid",
  revision_id: "sketch-revision-uuid",
  view_type: "front",
  image_url: "https://sketch.png",
  image_hash: "sha256...",
  batch_id: "sketches-[timestamp]",

  analysis_data: {
    category: "technical_sketch",
    sketch_type: "front_technical",

    // AI-generated call-outs (user can edit/add/remove)
    callOuts: [
      {
        id: "uuid",
        label: "A",
        title: "Collar Stand",
        description: "2.5cm height, fused interlining, topstitch 0.3cm from edge",
        position: { x: 150, y: 200 }, // Canvas coordinates
        component_type: "collar",
        technical_requirements: {
          height: "2.5cm",
          interlining: "fused",
          topstitch_distance: "0.3cm"
        },
        marker_style: {
          color: "#1C1917",
          size: 24,
          shape: "circle"
        },
        order: 1,
        is_user_added: false
      },
      {
        id: "uuid",
        label: "B",
        title: "Shoulder Seam",
        description: "Flat-fell seam, 1.2cm seam allowance",
        position: { x: 200, y: 150 },
        component_type: "seam",
        technical_requirements: {
          seam_type: "flat-fell",
          seam_allowance: "1.2cm"
        },
        marker_style: {
          color: "#1C1917",
          size: 24,
          shape: "circle"
        },
        order: 2,
        is_user_added: false
      }
      // ... 10-15 more call-outs
    ],

    // Overall sketch analysis
    sketch_quality: "high",
    line_weight: "consistent",
    proportions: "accurate",
    total_callouts: 12,
    user_added_callouts: 0
  },

  model_used: "gpt-4o",
  confidence_score: 0.88,
  status: "completed",

  metadata: {
    svgUrl: "https://...",
    source_view: "front-view-uuid"
  }
}
```

### Product Files

**Store in:** `images_uploads`

```typescript
// User-uploaded logo
{
  product_idea_id: "uuid",
  user_id: "uuid",
  upload_type: "original",
  file_name: "brand-logo.png",
  image_url: "https://...",
  thumbnail_url: "https://...",
  file_size: 102400,
  mime_type: "image/png",
  width: 500,
  height: 500,
  metadata: {
    category: "user_upload",
    file_type: "logo",
    upload_date: "2025-..."
  }
}

// Print file (SVG)
{
  product_idea_id: "uuid",
  user_id: "uuid",
  upload_type: "edited",
  file_name: "front-view-print.svg",
  image_url: "https://...",
  file_size: 50000,
  mime_type: "image/svg+xml",
  metadata: {
    category: "print_file",
    source_image_id: "original-revision-uuid",
    format: "svg",
    resolution: "vector",
    generated_at: "2025-..."
  }
}

// Print file (PDF)
{
  product_idea_id: "uuid",
  user_id: "uuid",
  upload_type: "edited",
  file_name: "front-view-layout.pdf",
  image_url: "https://...",
  file_size: 200000,
  mime_type: "application/pdf",
  metadata: {
    category: "print_file",
    source_image_id: "original-revision-uuid",
    format: "pdf",
    dimensions: { width: 3000, height: 4000 },
    dpi: 300
  }
}
```

### Summary in product_ideas.technical_files_v2

```typescript
{
  version: "2.0",
  baseViews: {
    batchId: "base-views-123",
    creditsUsed: 3,
    status: "approved",
    generatedAt: "2025-...",
    revisionIds: ["uuid1", "uuid2", "uuid3", "uuid4", "uuid5"]
  },
  closeUps: {
    batchId: "closeups-123",
    creditsUsed: 3,
    status: "completed",
    generatedAt: "2025-...",
    count: 8,
    revisionIds: ["uuid6", "uuid7", ...]
  },
  technicalSketches: {
    batchId: "sketches-123",
    creditsUsed: 3,
    status: "completed",
    generatedAt: "2025-...",
    revisionIds: ["uuid14", "uuid15", "uuid16"],
    totalCallOuts: 18
  },
  productFiles: {
    userUploads: ["upload-uuid1", "upload-uuid2"],
    printFiles: ["print-uuid1", "print-uuid2"],
    totalSize: 1024000
  },
  totalCreditsUsed: 9
}
```

---

## ðŸŽ¨ View-Specific Editing Workflow

### Concept: Image as Reference for Tech Pack Editing

**Key Innovation:** Users can edit tech pack data for each view individually, using the actual image as a reference for AI-assisted refinement.

### User Flow:

```
1. Generate Base Views (5 views, 3 credits)
   â†“
2. AI automatically analyzes each view â†’ revision_vision_analysis
   â†“
3. User clicks on any view (e.g., "Front View")
   â†“
4. Side panel opens showing:
   - Full image preview
   - AI-extracted tech pack fields (editable)
   - "Edit with AI" section
   â†“
5. User can:
   a) Edit fields directly (dimensions, features, materials)
   b) Use AI with image reference ("make sleeves longer")
   c) Regenerate entire view with new prompt
   â†“
6. All changes tracked in revision_vision_analysis.analysis_data
```

### Side Panel UI Design:

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Front View - Tech Pack Details          [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â”‚   [Large Image Preview]            â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â”‚   (600x800px)                      â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                              â”‚
â”‚  ðŸ“ Product Features (AI-Extracted)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Silhouette:  [fitted      â–¼]       â”‚     â”‚
â”‚  â”‚ Neckline:    [crew neck   â–¼]       â”‚     â”‚
â”‚  â”‚ Sleeves:     [short sleeve â–¼]      â”‚     â”‚
â”‚  â”‚ Closure:     [pullover    â–¼]       â”‚     â”‚
â”‚  â”‚ Hem:         [straight    â–¼]       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚  ðŸ“ Dimensions (AI-Estimated)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Shoulder:  [45cm] Â± [1cm]          â”‚     â”‚
â”‚  â”‚ Chest:     [50cm] Â± [1cm]          â”‚     â”‚
â”‚  â”‚ Length:    [65cm] Â± [1cm]          â”‚     â”‚
â”‚  â”‚ Sleeves:   [20cm] Â± [0.5cm]        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚  ðŸ§µ Materials (AI-Detected)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ â€¢ Cotton Jersey (95%)    [âœŽ] [Ã—]   â”‚     â”‚
â”‚  â”‚   Main body, 180gsm                â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â”‚ â€¢ Elastane (5%)          [âœŽ] [Ã—]   â”‚     â”‚
â”‚  â”‚   Stretch blend                    â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â”‚ â€¢ Ribbed Cotton (100%)   [âœŽ] [Ã—]   â”‚     â”‚
â”‚  â”‚   Collar, 2x1 rib                  â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â”‚ [+ Add Material]                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                              â”‚
â”‚  âœ¨ Edit with AI (Use Image as Reference)   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Describe changes:                  â”‚     â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚ â”‚ "Make the sleeves longer"      â”‚ â”‚     â”‚
â”‚  â”‚ â”‚ "Change to v-neck"             â”‚ â”‚     â”‚
â”‚  â”‚ â”‚ "Add side pockets"             â”‚ â”‚     â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â”‚ [Generate New Version]             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                              â”‚
â”‚  ðŸ”„ Actions                                  â”‚
â”‚  [Regenerate]  [Save Changes]  [Approve]    â”‚
â”‚                                              â”‚
â”‚  ðŸ“œ Edit History (3 changes)                 â”‚
â”‚  â€¢ Changed neckline: crew â†’ v-neck           â”‚
â”‚  â€¢ Adjusted shoulder width: 45cm â†’ 47cm      â”‚
â”‚  â€¢ Added material: Elastane blend            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Edit Operations:

#### 1. Direct Field Editing

```typescript
// User changes "Neckline" from "crew neck" to "v-neck"

PATCH /api/tech-pack/analysis/:analysisId
{
  field: "analysis_data.detected_features.neckline",
  value: "v-neck"
}

// Database update
UPDATE revision_vision_analysis
SET
  analysis_data = jsonb_set(
    analysis_data,
    '{detected_features,neckline}',
    '"v-neck"'
  ),
  analysis_data = jsonb_set(
    analysis_data,
    '{edit_history}',
    analysis_data->'edit_history' || '[{
      "timestamp": "2025-01-10T10:30:00Z",
      "field": "detected_features.neckline",
      "old_value": "crew neck",
      "new_value": "v-neck",
      "edited_by": "user-uuid"
    }]'::jsonb
  ),
  analysis_data = jsonb_set(
    analysis_data,
    '{user_modifications}',
    'true'
  ),
  updated_at = NOW()
WHERE id = 'analysis-uuid'
```

#### 2. AI Edit with Image Reference

```typescript
// User types: "Make sleeves longer" with current image as reference

POST /api/tech-pack/views/:revisionId/edit-with-ai
{
  prompt: "Make sleeves longer",
  preserve_features: ["neckline", "closure"] // Keep these unchanged
}

Implementation:
1. Load current revision + analysis
2. Generate new image with AI:
   - Input image: current front view
   - Prompt: "Modify this {silhouette} {neckline} shirt to have longer sleeves"
   - Style preservation: Keep overall design consistent
3. Create new revision in product_multiview_revisions:
   {
     parent_revision_id: "original-uuid",
     view_type: "front",
     edit_prompt: "Make sleeves longer",
     edit_type: "ai_edit",
     batch_id: "same-batch-id" // Keep same batch
   }
4. AI analyzes new image â†’ new revision_vision_analysis
5. Return comparison:
   {
     original: { image_url, analysis },
     edited: { image_url, analysis },
     changes: {
       sleeves: "short sleeve" â†’ "long sleeve",
       dimensions: { sleeve_length: "20cm" â†’ "58cm" }
     }
   }
```

#### 3. Full Regeneration

```typescript
// User clicks "Regenerate" with completely new prompt

POST /api/tech-pack/views/:revisionId/regenerate
{
  prompt: "Modern oversized fit t-shirt with drop shoulders",
  replace_current: true
}

Implementation:
1. Generate brand new image (no reference to current)
2. Create new revision
3. AI analyzes â†’ new revision_vision_analysis
4. If replace_current=true:
   - Set old revision.is_active = false
   - Set new revision.is_active = true
5. Keep old revision for history
```

### Benefits:

1. âœ… **Image as single source of truth** - Tech pack derived from actual visual
2. âœ… **User control** - Can correct AI mistakes via direct editing
3. âœ… **AI-assisted refinement** - Use image for contextual edits
4. âœ… **Full revision history** - Never lose previous versions
5. âœ… **No data duplication** - One analysis per image
6. âœ… **Flexible workflow** - Mix manual and AI edits
7. âœ… **Quality tracking** - Confidence scores guide user trust
8. âœ… **Easy rollback** - Can revert to any previous version

---

## ðŸ”„ Dynamic AI Analysis for Different Product Types

### How AI Adapts to Each Product:

The AI analyzes the image and **automatically determines the product type**, then extracts relevant fields accordingly:

#### Example 1: T-Shirt (Apparel)
```typescript
analysis_data: {
  detected_features: {
    silhouette: "fitted",
    neckline: "crew neck",
    sleeves: "short sleeve",
    closure: "pullover"
  },
  dimensions: {
    shoulder_width: "45cm",
    chest_width: "50cm",
    length: "65cm"
  }
}
```

#### Example 2: Sneakers (Footwear)
```typescript
analysis_data: {
  detected_features: {
    style: "high-top",
    closure: "lace-up",
    toe_shape: "rounded",
    ankle_support: "padded collar"
  },
  dimensions: {
    heel_height: "2.5cm",
    platform_height: "1.5cm",
    shaft_height: "12cm"
  },
  materials_detected: [
    { name: "Leather", component: "upper", spec: "full-grain" },
    { name: "Rubber", component: "outsole", spec: "vulcanized" },
    { name: "EVA Foam", component: "midsole", spec: "compression molded" }
  ]
}
```

#### Example 3: Handbag (Accessories)
```typescript
analysis_data: {
  detected_features: {
    style: "tote bag",
    closure: "magnetic snap",
    handle_type: "rolled leather handles",
    compartments: "single main compartment"
  },
  dimensions: {
    width: "35cm",
    height: "30cm",
    depth: "15cm",
    handle_drop: "25cm"
  },
  materials_detected: [
    { name: "Saffiano Leather", component: "exterior", spec: "cross-grain finish" },
    { name: "Cotton Canvas", component: "lining", spec: "durable weave" },
    { name: "Brass Hardware", component: "closure/feet", spec: "gold-plated" }
  ]
}
```

#### Example 4: Chair (Furniture)
```typescript
analysis_data: {
  detected_features: {
    style: "accent chair",
    back_style: "tufted high back",
    armrests: "rolled arms",
    legs: "tapered wooden legs"
  },
  dimensions: {
    overall_width: "75cm",
    overall_depth: "80cm",
    overall_height: "95cm",
    seat_height: "45cm",
    seat_depth: "50cm"
  },
  materials_detected: [
    { name: "Velvet Upholstery", component: "seat/back", spec: "100% polyester, 450gsm" },
    { name: "High-Density Foam", component: "cushioning", spec: "35 density" },
    { name: "Oak Wood", component: "frame/legs", spec: "solid hardwood" }
  ]
}
```

#### Example 5: Earrings (Jewelry)
```typescript
analysis_data: {
  detected_features: {
    style: "drop earrings",
    closure: "post with butterfly back",
    setting_type: "prong setting",
    gemstone_cut: "round brilliant"
  },
  dimensions: {
    total_length: "3.5cm",
    width: "0.8cm",
    gemstone_diameter: "6mm",
    post_thickness: "0.9mm"
  },
  materials_detected: [
    { name: "14K Gold", component: "setting/post", spec: "yellow gold" },
    { name: "Cubic Zirconia", component: "stones", spec: "AAA grade, 2ct total" }
  ]
}
```

### AI Prompt Engineering:

The system uses different AI prompts based on product category detection:

```typescript
// AI Vision Analysis Prompt (Dynamic)
const analyzeProduct = async (imageUrl: string) => {
  // Step 1: Detect product category
  const category = await detectCategory(imageUrl);
  // Returns: "apparel", "footwear", "bags", "furniture", "jewelry", etc.

  // Step 2: Use category-specific analysis prompt
  const prompts = {
    apparel: `Analyze this ${category} image and extract:
      - Silhouette, neckline, sleeves, closure, fit
      - Estimated dimensions (shoulder, chest, length, etc.)
      - Materials visible (fabric type, weight, finish)
      - Construction details (seams, stitching, reinforcements)
      - Color analysis with Pantone matching
      - Manufacturing complexity and cost estimation`,

    footwear: `Analyze this ${category} image and extract:
      - Style (sneaker, boot, sandal, heel, etc.)
      - Closure type (lace, zipper, slip-on, buckle)
      - Toe shape, heel height, platform
      - Materials (leather, canvas, rubber, sole type)
      - Construction (stitched, cemented, vulcanized)
      - Sizing and fit notes`,

    bags: `Analyze this ${category} image and extract:
      - Bag style (tote, crossbody, clutch, backpack)
      - Closure mechanism (zipper, magnetic, drawstring)
      - Handle/strap type and attachment
      - Interior compartments and organization
      - Dimensions (width, height, depth, strap drop)
      - Materials (leather type, hardware, lining)`,

    furniture: `Analyze this ${category} image and extract:
      - Furniture type and style
      - Frame construction and materials
      - Upholstery fabric and cushioning
      - Dimensions (width, depth, height, seat height)
      - Joinery and assembly method
      - Weight capacity and durability notes`,

    jewelry: `Analyze this ${category} image and extract:
      - Jewelry type (ring, necklace, earrings, bracelet)
      - Metal type and purity (gold, silver, platinum)
      - Stone type, cut, and setting
      - Closure mechanism
      - Dimensions and weight
      - Craftsmanship details (hand-made, cast, etc.)`
  };

  // Step 3: Analyze with category-specific prompt
  const analysis = await aiVisionAnalyze(imageUrl, prompts[category]);

  return {
    category,
    analysis_data: analysis
  };
};
```

### Result:

- âœ… **Shoe images** â†’ Get heel height, toe shape, outsole type
- âœ… **Bag images** â†’ Get strap drop, compartments, closure type
- âœ… **Furniture images** â†’ Get seat height, cushion depth, frame materials
- âœ… **Jewelry images** â†’ Get stone size, metal purity, setting type
- âœ… **Apparel images** â†’ Get neckline, sleeves, fit type

**The system is fully dynamic and product-agnostic!**

---

## ðŸ”§ API Endpoints (Using Existing Schema)

### 1. Generate Base Views

```typescript
POST /api/tech-pack/base-views/generate

Request:
{
  productIdeaId: string;
  prompt?: string;
}

Implementation:
1. Check user credits >= 3
2. Generate 5 images (front, back, side, top, bottom)
3. Create 5 records in product_multiview_revisions
   - Same batch_id for all
   - view_type = front/back/side/top/bottom
   - metadata.category = "base_view"
4. Create record in front_view_approvals
   - status = "pending"
   - credits_reserved = 3
5. Update product_ideas.technical_files_v2
6. Deduct 3 credits from user_credits
7. Return { success, baseViews, creditsUsed: 3 }
```

### 2. Approve/Edit Base View

```typescript
PATCH /api/tech-pack/base-views/:revisionId

Request:
{
  action: "approve" | "edit" | "regenerate";
  editParams?: { prompt: string };
}

Implementation:
1. Load revision from product_multiview_revisions
2. If regenerate: create new revision with parent_revision_id
3. If approve: Update is_active = true, metadata.approved = true
4. Update front_view_approvals status
5. Return { success, view }
```

### 3. Generate Close-Ups

```typescript
POST /api/tech-pack/close-ups/generate

Request:
{
  productIdeaId: string;
  baseViewIds: string[]; // Required: use approved base views
}

Implementation:
1. Check user credits >= 3
2. Check baseViewIds are approved
3. Generate 6-10 close-up images with AI titles/descriptions
4. Create records in product_multiview_revisions
   - view_type = "illustration"
   - metadata.category = "close_up"
   - metadata.title, description from AI
5. Cache analysis in image_analysis_cache
6. Update product_ideas.technical_files_v2
7. Deduct 3 credits
8. Return { success, closeUps, creditsUsed: 3 }
```

### 4. Edit Close-Up

```typescript
PATCH /api/tech-pack/close-ups/:revisionId

Request:
{
  title?: string;
  description?: string;
  notes?: string;
}

Implementation:
1. Load revision from product_multiview_revisions
2. Update metadata.title, description, notes
3. Set metadata.is_user_edited = true
4. Return { success, closeUp }
```

### 5. Regenerate Close-Up

```typescript
POST /api/tech-pack/close-ups/:revisionId/regenerate

Implementation:
1. Load original revision
2. Generate new image + AI analysis
3. Create new revision with parent_revision_id
4. Deactivate old revision (is_active = false)
5. Return { success, closeUp }
```

### 6. Delete Close-Up

```typescript
DELETE /api/tech-pack/close-ups/:revisionId

Implementation:
1. Set is_deleted = true, deleted_at = now()
2. Return { success }
```

### 7. Reorder Close-Ups

```typescript
PATCH /api/tech-pack/close-ups/reorder

Request:
{
  productIdeaId: string;
  closeUpIds: string[]; // New order
}

Implementation:
1. Load all close-up revisions
2. Update metadata.order for each
3. Return { success }
```

### 8. Generate Technical Sketches

```typescript
POST /api/tech-pack/sketches/generate

Request:
{
  productIdeaId: string;
  baseViewIds: string[]; // front, back, side
}

Implementation:
1. Check user credits >= 3
2. Generate 3 technical sketches
3. For each sketch, generate AI call-outs (A, B, C...)
4. Create records in product_multiview_revisions
   - view_type = "front", "back", "side"
   - metadata.category = "technical_sketch"
   - metadata.callOuts = [...]
5. Update product_ideas.technical_files_v2
6. Deduct 3 credits
7. Return { success, sketches, creditsUsed: 3 }
```

### 9. Update Call-Out

```typescript
PATCH /api/tech-pack/call-outs/:sketchId/:callOutId

Request:
{
  title?: string;
  description?: string;
  position?: { x: number; y: number };
}

Implementation:
1. Load sketch revision from product_multiview_revisions
2. Find call-out in metadata.callOuts array
3. Update fields
4. Save metadata
5. Return { success, callOut }
```

### 10. Add Custom Call-Out

```typescript
POST /api/tech-pack/call-outs/:sketchId

Request:
{
  title: string;
  description: string;
  position: { x: number; y: number };
}

Implementation:
1. Load sketch revision
2. Generate next label (A, B, C... AA, AB...)
3. Add to metadata.callOuts array
   - is_user_added = true
4. Save metadata
5. Return { success, callOut }
```

### 11. Delete Call-Out

```typescript
DELETE /api/tech-pack/call-outs/:sketchId/:callOutId

Implementation:
1. Load sketch revision
2. Remove from metadata.callOuts array
3. Reorder remaining labels if needed
4. Save metadata
5. Return { success }
```

### 12. Upload Product File

```typescript
POST /api/tech-pack/files/upload

Request: FormData
{
  productIdeaId: string;
  file: File;
  category: "logo" | "artwork" | "custom";
}

Implementation:
1. Upload file to storage
2. Create record in images_uploads
   - upload_type = "original"
   - metadata.category = "user_upload"
3. Update product_ideas.technical_files_v2.productFiles
4. Return { success, file }
```

### 13. Generate Print Files

```typescript
POST /api/tech-pack/print-files/generate

Request:
{
  imageId: string; // Revision ID
  formats: ["png", "svg", "pdf"];
}

Implementation:
1. Load source image from product_multiview_revisions
2. Generate requested formats:
   - PNG: High-res (300dpi), no background
   - SVG: Vectorize with edge detection
   - PDF: Layout with crop marks
3. Create records in images_uploads
   - upload_type = "edited"
   - metadata.category = "print_file"
   - metadata.source_image_id = imageId
4. Return { success, printFiles }
```

### 14. Download All Files as ZIP

```typescript
GET /api/tech-pack/export/:productIdeaId/zip

Implementation:
1. Query all files:
   - Base views from product_multiview_revisions
   - Close-ups from product_multiview_revisions
   - Sketches from product_multiview_revisions
   - User uploads from images_uploads
   - Print files from images_uploads
2. Create ZIP structure:
   - base-views/ (10 files: PNG + SVG)
   - close-ups/
   - technical-sketches/
   - print-files/
   - user-files/
3. Generate PDF tech pack
4. Add materials.csv
5. Add README.txt
6. Stream ZIP
7. Return ZIP file
```

---

## ðŸŽ¨ React Components (Using Existing Data)

### TechFilesTab Component

```typescript
// Main tab for tech files
export function TechFilesTab({ productIdeaId }: Props) {
  // Load data from existing tables
  const { data: baseViews } = useQuery({
    queryKey: ['base-views', productIdeaId],
    queryFn: async () => {
      // Query product_multiview_revisions
      // WHERE product_idea_id = productIdeaId
      // AND metadata->>'category' = 'base_view'
      // AND is_active = true
    }
  });

  const { data: closeUps } = useQuery({
    queryKey: ['close-ups', productIdeaId],
    queryFn: async () => {
      // Query product_multiview_revisions
      // WHERE view_type = 'illustration'
      // AND metadata->>'category' = 'close_up'
    }
  });

  const { data: sketches } = useQuery({
    queryKey: ['sketches', productIdeaId],
    queryFn: async () => {
      // Query product_multiview_revisions
      // WHERE metadata->>'category' = 'technical_sketch'
    }
  });

  const { data: productFiles } = useQuery({
    queryKey: ['product-files', productIdeaId],
    queryFn: async () => {
      // Query images_uploads
      // WHERE product_idea_id = productIdeaId
    }
  });

  return (
    <div>
      <BaseViewsSection views={baseViews} />
      <CloseUpsSection closeUps={closeUps} />
      <TechnicalSketchesSection sketches={sketches} />
      <ProductFilesSection files={productFiles} />
    </div>
  );
}
```

---

## ðŸ“ˆ Credits Flow

```typescript
// BEFORE Tech Files 2.0
Tech Pack Generation: 0 credits (free)
Technical Files: 6 credits
Total: 6 credits

// AFTER Tech Files 2.0
Tech Pack Generation: 0 credits (free) âœ… Keep
Base Views (5 views): 3 credits ðŸ†• New
Close-Ups (6-10 details): 3 credits ðŸ†• New
Technical Sketches (3 + call-outs): 3 credits ðŸ†• New
Total for Complete Pack: 9 credits

// Credits deduction logic
1. User generates base views â†’ -3 credits
2. User generates close-ups â†’ -3 credits (requires base views)
3. User generates tech sketches â†’ -3 credits (requires base views)

// Track in user_credits table
UPDATE user_credits
SET credits = credits - 3
WHERE user_id = 'uuid'
```

---

## ðŸš€ Implementation Steps

### Phase 1: Backend (Week 1-2)

1. **Create API endpoints** (12 new endpoints)
2. **Update credit system** to track new features
3. **Add batch generation** for base views/close-ups/sketches
4. **Implement AI services**:
   - Close-up title/description generation
   - Call-out generation
   - Technical sketch conversion
5. **Add caching** using `image_analysis_cache`

### Phase 2: Frontend (Week 2-3)

1. **Create TechFilesTab** component
2. **Build sub-components**:
   - BaseViewsSection
   - CloseUpsSection
   - TechnicalSketchesSection
   - ProductFilesSection
3. **Add side panels**:
   - BaseViewSidePanel
   - CloseUpSidePanel
   - CallOutSidePanel (with canvas)
   - FilesManagerSidePanel
4. **Implement drag & drop** for file uploads

### Phase 3: Export (Week 3-4)

1. **PDF generation** with all sections
2. **ZIP bundling** with folder structure
3. **CSV export** for materials
4. **Print file generation** (PNG/SVG/PDF)

### Phase 4: Testing (Week 4-5)

1. Unit tests for API endpoints
2. Integration tests for workflows
3. E2E tests for user flows
4. Performance testing

---

## âœ… Advantages of This Approach

1. âœ… **No database migration** - Use existing schema
2. âœ… **Backward compatible** - Existing tech packs work
3. âœ… **Flexible** - JSONB allows schema evolution
4. âœ… **Fast implementation** - Less infrastructure changes
5. âœ… **Reuse existing code** - Credit system, image upload, approvals
6. âœ… **Proven architecture** - Builds on tested patterns

---

## ðŸŽ¯ Success Metrics

- Generate 5 base views in < 30 seconds
- Generate 8 close-ups in < 45 seconds
- Generate 3 sketches + call-outs in < 60 seconds
- Complete tech pack export (ZIP) in < 10 seconds
- Support 100+ concurrent users
- 99.9% uptime for API

---

**End of Simplified Implementation Plan**
